<html>
<head>
<script>document.domain = document.domain;</script>
<title>muxlist</title>
<script src="/static/jquery-1.4.2.min.js"></script>
<!-- script src="http://code.jquery.com/jquery-1.4.4.min.js"></script -->
<script src="/static/Orbited.js"></script>
<script>
Orbited.settings.port = 9000;
Orbited.settings.hostname = "{{ hostname }}";
TCPSocket = Orbited.TCPSocket
</script>
<script src="/static/stomp.js"></script>
<script src="/static/jquery.client.js"></script>
<script src="/static/jquery.dnd-file-upload.js"></script>
<script src="/static/jquery.jplayer.min.js"></script>
<script>
var stomp;
$(document).ready(function () {
	stomp = new STOMPClient();
	stomp.onconnectedframe = function () {
		$("<li><i>Connected to channel /mix/{{ group.name }} -- this shit is sooo cash!</i></li>").appendTo('#stream');
		stomp.subscribe('/mix/{{ group.name }}');
	};
        stomp.onmessageframe = function (frame) {
		data = JSON.parse(frame.body);
		if (data.type == 'chat') {
			$('<li><b>' + data.user + '</b>: ' + data.message + '</li>').appendTo('#stream');
		} else if (data.type == 'song') {
			$('<li><b>' + data.user + '</b> is playing <b>' + data.artist + ' - ' + data.title + '</b></li>').appendTo('#stream');
			$('#jplayer').jPlayer('stop').jPlayer('setFile', data.url).jPlayer('play');
			
		}
	}
	stomp.connect('localhost', 61613);

{% if user.is_authenticated %}
	$("#everything").dropzone({ url: '/music/upload2/' });

        var noms = ["NOM nom nom", "nom NOM nom", "nom nom NOM"]
        var nom_index = 0;
        var nommer = null;
        function do_the_nom() {
            $('#drop').html(noms[nom_index++])
            if (nom_index >= noms.length) { nom_index = 0; }
	}

        $.fn.dropzone.uploadStarted = function (fileIndex, file) {
            if (nommer != null) { clearInterval(nommer); }
            nommer = setInterval(do_the_nom, 250);
	}

        $.fn.dropzone.uploadFinished = function (fileIndex, file, timeDiff, event) {
           clearInterval(nommer);
           $('#drop').html("Yum, thanks!");
	}

	$.fn.dropzone.uploadFinishedResponse = function (xhr) {
		play_song(xhr.responseText);
	}
{% endif %}

	$('#jplayer').jPlayer({ nativeSupport: true, swfPath: '/static/' });
});
function send_chat() {
	$.post('./add/', {'msg': $('#message').val()});
	$('#message').val('').focus();
}
function play_song(id) {
	$.post('./song/', {'id': id});
}
function send_chat_enter(event) {
	if (event.keyCode == 13) {
		send_chat();
	}
}
</script>
</head>
<body>
<div id="everything" style="height:100%">
<div id="container" style="width:600px;margin:auto;">
<div id="jplayer"></div>
{% if user.is_authenticated %}
Logged in as {{ user }} <a href="/account/logout/">Logout</a>
{% endif %}
<ul id="stream">
</ul>
{% if user.is_authenticated %}
Chat: <input type="text" id="message" onkeypress="send_chat_enter(event)"><input type="button" value="Send" onclick="send_chat()">
{% endif %}
<ol>
{% for h in history %}
<li>{{ h.1 }}</li>
{% endfor %}
</ol>
</div>
</div>
</body>
</html>
