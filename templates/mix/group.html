<html>
<head>
<script>document.domain = document.domain;</script>
<title>muxlist</title>
<script src="/static/jquery-1.4.2.min.js"></script>
<!-- script src="http://code.jquery.com/jquery-1.4.4.min.js"></script -->
<script src="/static/Orbited.js"></script>
<script>
Orbited.settings.port = 9000;
Orbited.settings.hostname = "{{ hostname }}";
TCPSocket = Orbited.TCPSocket
</script>
<script src="/static/stomp.js"></script>
<script src="/static/jquery.client.js"></script>
<script src="/static/jquery.dnd-file-upload.js"></script>
<script src="/static/jquery.jplayer.min.js"></script>
<script>
var stomp;
var comet_ready;
$(document).ready(function () {
	comet_ready = function() {
		console.log("ready");
		$.post('./current/', function (data) { console.log(data); stomp.onmessageframe({'body': data});});
	}
	stomp = new STOMPClient();
	stomp.onconnectedframe = function () {
		$("<li><i>thundercats are go</i></li>").appendTo('#stream');
		stomp.subscribe('/group/{{ group.id }}');
		// why??
                setTimeout("comet_ready()", 100)
	};
	stomp.onreceiptframe = function (frame) {
		data = JSON.parse(frame.body)
                console.log(frame)
	}
        stomp.onmessageframe = function (frame) {
		data = JSON.parse(frame.body);
                console.log("message", data)
		if (data.type == 'chat') {
			$('<li><b>' + data.user + '</b>: ' + data.msg + '</li>').appendTo('#stream');
		} else if (data.type == 'track') {
			$('#current').html('');
			$('#cover_art').attr('src', '');
                        if (data.track.cover_art) {
				$('#cover_art').attr('src', data.track.cover_art);
			}
			$('<h1>' + data.track.title + '</h1><h2>on ' + data.track.album + '</h2><h2>by ' + data.track.artist + '</h2><h3>from ' + data.user + '</h3><div id="progress_outer"><div id="progress_inner"></div></div>').appendTo('#current');
			$('<li><div><b>' + data.user + '</b> is playing <b>' + data.track.artist + ' - ' + data.track.title + '</b></li>').appendTo('#stream');
			$('#current').fadeIn();
			var jp = $('#jplayer');
			jp.jPlayer('stop');
			jp.jPlayer('setMedia',{mp3: data.track.url});
                        if ('time' in data) {
				console.log("time:", data.time)
				jp.jPlayer("play", data.time)
			} else {
				jp.jPlayer("play");
			}
			
		} else if (data.type == 'debug') {
			$('<li><i>DEBUG: ' + data.msg + '</i></li>').appendTo('#stream')
		}
	}
	stomp.connect('localhost', 61613);

{% if user.is_authenticated %}
	$("#everything").dropzone({ url: '/music/begin_slice/' });

	$.fn.dropzone.uploadStarted = function () {
		$('#uploading').html('<img src="/static/throbber.gif"> Uploading...');
	}

	$.fn.dropzone.uploadFinishedResponse = function (xhr) {
		var file = $.fn.getLastFile();
		if (xhr.status == 200) {
			$.fn.clearLastFile();
			if ($.fn.getURL() == '/music/begin_slice/') {
				console.log("worked on first try");
			} else {
				console.log("we're good!");
			}
			$.fn.setURL('/music/begin_slice/');
			$('#uploading').html('')
			return;
		}

		if ($.fn.getURL() == '/music/begin_slice/') {
			if (xhr.status == 402) {
				$.fn.setURL('/music/middle_slice/');
				var size = file.fileSize;
				console.log("trying next");
				$.fn.startXHRSlice(file, xhr.upload.fileIndex + 1, Math.floor(size/2)-50, Math.floor(size/2)+50);
				return;
			} else if (xhr.status == 404) {
				console.log(file);
				$.fn.setURL('/music/upload/');
				console.log("trying all from begin");
				$.fn.startXHRAll(file, xhr.upload.fileIndex + 1);
				return;
			}
		}

		if ($.fn.getURL() == '/music/middle_slice/') {
			if (xhr.status == 402) {
				$.fn.setURL('/music/end_slice/');
				var size = file.fileSize;
				console.log("trying next");
				$.fn.startXHRSlice(file, xhr.upload.fileIndex + 1, size-100, size);
				return;
			} else if (xhr.status == 404) {
				$.fn.setURL('/music/upload/');
				console.log('trying all');
				$.fn.startXHRAll(file, xhr.upload.fileIndex + 1);
				return;
			}
		}
	}
{% endif %}

	function song_ended() {
		$('#current').fadeOut();
                console.log("requesting next");
		$.post('./next/')
	}

var baz = true;
	function update_progress(event) {
		$('#progress_inner').css('width', event.jPlayer.status.currentPercentAbsolute + '%')
	}

	$('#jplayer').jPlayer({
		ended: song_ended,
		timeupdate: update_progress,
		swfPath: '/static/',
		solution: $.browser.webkit ? 'flash, html' : 'html, flash',
                supplied: 'mp3',
		preload: 'auto'
	});
});
function send_chat() {
	$.post('./add/', {'msg': $('#message').val()});
	$('#message').val('').focus();
}
function send_next() {
	$.post('./force-next/');
}
function send_chat_enter(event) {
	if (event.keyCode == 13) {
		send_chat();
	}
}
</script>
<style>
body { margin: 0; padding: 0; }
h1, h2, h3 { margin: 0px; }
#progress_outer { height:10px; width:200px; border:1px solid; background:white; }
#progress_inner { height:10px; background: black; width: 0%; }
</style>
</head>
<body>
<div id="everything" style="height:100%">
<div id="container" style="width:600px;margin:auto;">
<div id="jplayer"></div>
<div>
muxlist // {{ group.name }}
{% if user.is_authenticated %}
<span style="float:right">
Logged in as {{ user }} <a href="/account/logout/">Logout</a>
</span>
{% else %}
<span style="float:right">
<a href="/account/login?next=/mix/{{ group.name }}/">Login to add tracks</a>
</span>
{% endif %}
</div>
<div style="height:174px;border:1px solid;"><img id="cover_art" style="float:left"><div id="current" style="float:left">Nothing queued</div></div>
<ul id="stream">
</ul>
{% if user.is_authenticated %}
Chat: <input type="text" id="message" onkeypress="send_chat_enter(event)"><input type="button" value="Send" onclick="send_chat()"><input type="button" value="Next" onclick="send_next()"><span id="uploading"></span>
{% endif %}
</div>
</div>
</body>
</html>
